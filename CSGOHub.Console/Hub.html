<!DOCTYPE html>
<html>
<head>
    <title>CSGO Hub</title>
    <!--Script references. -->
    <!--Reference the jQuery library. -->
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.1/css/bootstrap.min.css">
    <script src="http://ajax.aspnetcdn.com/ajax/jQuery/jquery-2.1.4.min.js"></script>
    <!--Reference the SignalR library. -->
    <script src="http://ajax.aspnetcdn.com/ajax/signalr/jquery.signalr-2.2.0.min.js"></script>
    <!--Reference the autogenerated SignalR hub script. -->
    <script src="http://localhost:8080/signalr/hubs"></script>
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.6/js/bootstrap.min.js"></script>



</head>
<body>

    <div class="container text-center">
        <div class="row">
            <div class="col-md-4 ">
                <div>CT Score</div>
                <div id="ctScore"></div>
            </div>
            <div class="col-md-4">
                <div>Round</div>
                <div id="round"></div>
            </div>
            <div class="col-md-4">
                <div>T</div>
                <div id="tScore"></div>
            </div>
        </div>
        <div class="row">

            <div class="col-md-3">
                Bomb: <span id="bomb"></span>
            </div>
            <div class="col-md-3">
                RoundTime: <span id="roundTime"></span>
            </div>
        </div>
    </div>







    <script type="text/javascript">
        var round = {
            phase: "",
            timestart: 0,
            time: 0,
            maxTime: 0,
            bomb: {
                planted: false,
                timestart: 0,
                time: 0,
                maxTime: 40
            }
        };
            var bombTime = 40;
            var withoutDefuseTime = 10;
            var withDefuseTime = 5;

            var maxTime = 0;

            console.log("CSGO Hub");

            //Set the hubs URL for the connection
            $.connection.hub.url = "http://localhost:8080/signalr";

            // Declare a proxy to reference the hub.
            var hub = $.connection.csgoHub;

            // Create a function that the hub can call to broadcast messages.
            hub.client.update = function (payload) {
                if (payload.round) {
                    $('#round').html(payload.map.round);
                    $('#ctScore').html(payload.map.team_ct.score);
                    $('#tScore').html(payload.map.team_t.score);

                    if (!(round.phase === payload.round.phase)) {
                        round.timestart = payload.provider.timestamp;
                        round.phase = payload.round.phase;
                    }

                    var maxTime = 0;
                    if (payload.round.phase === 'live') {
                        maxTime = 115;
                    } else if (round.phase === 'freezetime') {
                        maxTime = 15;
                    } else {
                        maxTime = 7;
                    }
                    round.time = maxTime - (new Date().getTime() / 1000 - round.timestart);
                    round.maxTime = maxTime;

                    if (!round.bomb.planted && payload.round.bomb === 'planted') {
                        round.bomb.planted = true;
                        round.bomb.timestart = payload.provider.timestamp;
                    } else if (round.bomb.planted && payload.round.bomb !== 'planted') {
                        round.bomb.planted = false;
                    }

                    if (round.bomb.planted) {
                        round.bomb.time = 40 - (new Date().getTime() / 1000 - round.bomb.timestart);
                    }

                    payload.extra = {};
                    payload.extra.round = round;

                    round.time = maxTime - (new Date().getTime() / 1000 - payload.provider.timestamp);

                    $('#roundTime').html(round.time);
                }
            };


            $.connection.hub.start().done(function () {
                console.log("Hub started successfully");
            });


    </script>
</body>

</html>